---
title: 初探Http事务
tags:
  - http事务
categories:
  - 计算机网络
date: 2019-08-18 10:49:43
photo:
---

{% note default %}
对于像在浏览器中的地址栏中输入一个url，内在的过程是如何的呢？
{% endnote %}

<!-- more -->

## Web内容
在说http事务之前，有必要了解以下Web内容是个啥。

对于用万维网进行通信的客户端和服务端来说，在网络上传输的无非是Web内容，而这个内容是与一个**MIME**类型相关的字节序列。比如：
MIME类型		描述
text/html   HTML页面
text/plain  无格式文本
image/gif	Gif格式编码的二进制图像
···
···

Web服务器以两种方式来向客户端提供内容：
- 取一个磁盘文件，将其内容返回给客户端。这样的方式**服务静态内容**，磁盘文件就叫做**静态内容**。
- 运行一个可执行文件，将其输出返回给客户端。这样的方式**服务动态内容**，磁盘文件就叫做**动态内容**。

那么返回的内容都是与一个文件相关联的。这些文件有一个唯一的名字：URL，通用资源定位符。
**可执行文件的URL可以在文件后面包括程序参数，？号分隔文件名和参数，&分隔参数与参数**。

## HTTP事务
HTTP是基于网络连接上传送的文本行的。在此我们用Linux的telnet程序来和因特网上的任何Web服务器进行Http事务。
如图：
<img src="http://rensongwang.gitee.io/my_drawing_bed/HTTP事务.png">

在进行HTTP事务之前，肯定是要先与服务器建立连接的，所以要注意：
**在浏览器地址栏输入URL之后，通过DNS解析出IP地址之后不是马上就发送HTTP请求，得先建立连接才行**。

1. HTTP请求
一个HTTP请求的组成是：一个**请求行**，后面跟随0个或多个**请求报文**。
请求行的格式是：方法 URI 版本号
方法就是GET、POST、PUT、DELETE等。**URI是相应的URL的后缀，包括文件名和可选的参数**。（如果是代理服务器请求内容，这个URI必须是完整的URL）

1.1 请求报文
请求报文为服务器提供了额外的信息，比如浏览器的商标名，或者是浏览器理解的MIME类型。格式：
header-name: header-data
在上图中，我们发送的是Host报头，在HTTP/1.1中是需要的，在HTTP/1.0中是不需要的。
**代理缓存**会使用Host报头。我们理解成浏览器和管理被请求文件的原始服务器之间的**中介**。在客户端和原始服务器之间，可以有多个代理，即**代理链**。
Host包头中包含了原始服务器的域名，这**使得代理链中的代理能够判断在本地缓存中是否已经存在被请求的内容的副本**。

2. HTTP响应
一个HTTP响应的组成是：一个响应行，后面跟着0个或多个响应报头，最后是响应主体。
响应行的格式：
版本号 状态码 状态消息
状态码是很好理解的，它反映的是请求的返回结果的一个状态，是成功了还是失败了还是咋啦咋啦。

响应报头中包含了响应的附加信息，其中两个重要的报头我们可以在图中看到，Content-Type（告诉我们MIME的类型）和Content-Length（告诉我们响应主体的字节大小）。

## 服务动态内容的实现
客户端如何将程序参数传递给服务器？服务器又如何进行内部的参数传递以及返回结果？
**CGI（通用网关接口）**解决服务动态内容的实现。
- tips
**HTTP POST的请求的参数通过请求主体传递而非URI传递**。

服务器接收到一个动态内容的请求：
```
GET /cgi-bin/adder?15000&213 HTTP/1.1
```
会调用fork生成一个子进程，然后调用execve在子进程的上下文中执行/cgi-bin/adder，这个adder就是一个CGI程序，遵守CGI标准的规则。
在调用execve之前，**子进程将（setenv）CGI环境变量QUERY_STRING设置为15000&213，adder程序在运行时可以调用Linux getenv函数来引用它**。

当然还有其他很多的环境变量，程序在运行时可以设置，这样就可以将参数传递给其他子进程。

### 输出怎么送呢？
一种思路就是，我在adder程序里用sprintf进行输出，那么**就需要用dup2函数将瞄准输出重定向到和客户端相关的已连接描述符**。








--- 

